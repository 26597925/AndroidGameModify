# 内存断点的实现方式
```
1、设置该内存位置所在的页不可读/写
2、使用硬件断点实现

内存断点的实现方式有两种,一种是通过设置该内存位置所在的页不可读/写,然后当程序中对该内存进行读/写的时候就会触发异常,
调试器捕获到这个异常后范县这个不可读/写的异常是因为设置了内存断点,于是就断下来了;
还有一种方式是使用硬件断点,是的,硬件断点可以用来实现内存断点.当你把某个地址上设置了硬件读/写断点后,程序对该内存进行读写时CPU会触发一个异常,
调试器捕获该异常后发现是设置了硬件的读写断点后就断下来了。
仔细观察OD设置内存断点的菜单就会发现设置断点的菜单有内存读/写断点,还有硬件的读/写/执行断点。
Breakpoint -->	Memory, on access
				Memory, on write
				----------------------
				Hardware, on access
				Hardware, on write
				Hardware, on execution

想要详细了解这个可以看一下张银奎的<软件调试>一书。
```

# 设置该内存位置所在的页不可读/写
```
内存断点原理
前提：
①每一个程序运行时候都会申请一段内存地址并设置内存页的属性。例如：申请时可以设置该内存页内只存放数据，不执行代码等。
②程序调试运行时，调试器比被调试程序提前获取系统下发的异常消息。 使用OD程序调试时，若我们设置了内存断点，
OD将在该内存页添加一个属性，叫做PAGE_NOACCESS。从属性名可以看到，如内存页设置此属性后，将无法被访问或被访问产生异常。
程序运行访问下软件断点的地址时，OD通过调试器信息将程序暂停下来。

内存断点的实现方式是将你欲下断地址所在的内存页增加一个名为PAGE_NOACCESS的属性，这个属性会把当前内存页设为禁止任何形式的访问，
如果进行访问会触发一个内存访问异常。在这同时，od开始捕获目标程序中出现的这个异常，并判断触发这个异常的位置是否跟你下断的地址相同，
如果相同则内存断点触发，暂停被调试程序的运行，否则放行。这就是内存断点的基本原理，
补充一些相关的东西：
1.内存断点很消耗资源，因为PAGE_NOACCESS属性一设置就是一整个内存页无法访问，那么当程序访问该内存页中非断点地址的内容同样会触发异常，
这时od收到异常后需要进行特殊处理（怎么样处理才能让程序可以正常运行，比如内存页中有很多不是下断地址 被高频率写，而且这些内存不被改写，游戏会卡住），
临时放行，非常消耗资源，甚至这使得内存断点在调试很多大型程序时慢到近乎不可用。
2.虽然内存断点的效率经常很不理想，但是因为仅仅是修改了一个内存属性，所以内存断点可以下数量非常多、单断点范围非常大。这是它的优势。
3.只在写入时断下的内存断点通常是将内存属性设为PAGE_EXECUTE_READ，也就是不可写来实现的。对这种属性的内存进行写操作将会触发异常。
```

# 硬件断点
```
硬件断点原理
前提：
①在寄存器中，有一组寄存器用于调试。他们分别是 Dr0-Dr7。其中 Dr0-Dr3四个调试寄存器存放中断的地址。Dr4-Dr5 一般保留不用。 
Dr6-Dr7 两个用来记录Dr0-Dr3中下断点的地址的属性。例如：Dr0 中下断点的地址是硬件读还是写，还是执行；或是字节还是双字等。 
②硬件断点是CPU层面支持的。补充：这个也就是为什么硬件断点只有四个的原因（因为只有四个寄存器用于存放断点地址）。
使用OD程序调试时，若我们设置了硬件断点，OD本身不做什么复杂的操作，只是把我们的需求转化格式写入 Dr寄存器，等待系统反馈即可。

关于硬件断点：
1.寄存器数量的限制导致硬件断点最多只能同时存在4个，并且od在特定设置或者插件的影响下可能内部还会占用一两个用来辅助程序调试，导致可用数量十分有限。
2.不仅硬件断点数量不多，在32位程序中，每个硬件断点最大范围是4个字节，这也经常不太够用。
3.由于cpu的直接支持，硬件断点的效率是非常高的，给一个程序设置了硬件断点，在不触发的情况下，不会有肉眼可见的效率影响，毕竟只是写了个寄存器而已。

```

# 总结
```
内存断点通过修改内存页的属性并捕获异常来间接暂停被调试的程序运行，而硬件断点是由cpu直接提供支持。
因为这样，所以内存断点的效率大大低于硬件断点，但内存断点的自由性大于硬件断点，可以下很多很大不用担心硬件限制。
通常在调试程序时，能用硬件断点就别用内存断点，太[bi--]卡了。而且内存断点经常下了找不着，而硬件断点od有单独的窗口显示。


因为修改程序代码你想怎么改就怎么改。所以内存断点你可以设置很多个。而硬件寄存器数量有限，所以只能设置几个（目前大多数是4个）
因为修改的是程序的代码，所以内存断点很容易被程序自身检测到。而硬件断点则很难被发现。
```
